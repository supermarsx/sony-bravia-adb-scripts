name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # FORMAT CHECKS (run in parallel)
  # ============================================================================
  
  format-powershell:
    name: Format PowerShell
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PowerShell file formatting
        shell: pwsh
        run: |
          Write-Host "=== Checking PowerShell formatting ===" -ForegroundColor Cyan
          
          $issues = @()
          
          # Check for trailing whitespace
          $psFiles = Get-ChildItem -Path . -Filter "*.ps1" -Recurse
          foreach ($file in $psFiles) {
            $lines = Get-Content $file.FullName
            for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i] -match '\s+$') {
                $issues += "Trailing whitespace in $($file.Name):$($i+1)"
              }
            }
          }
          
          # Check for tabs (should use spaces)
          foreach ($file in $psFiles) {
            $content = Get-Content $file.FullName -Raw
            if ($content -match "`t") {
              $issues += "Tab character found in $($file.Name) (use spaces)"
            }
          }
          
          if ($issues.Count -gt 0) {
            $issues | ForEach-Object { Write-Host "âœ— $_" -ForegroundColor Red }
            exit 1
          }
          
          Write-Host "âœ“ PowerShell formatting looks good" -ForegroundColor Green

      - name: Check EditorConfig compliance
        uses: editorconfig-checker/action-editorconfig-checker@main
        with:
          version: '2.7.0'

  format-shell:
    name: Format Shell
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check shell script formatting
        run: |
          echo "=== Checking shell script formatting ==="
          
          # Check for CRLF line endings (should be LF only)
          if file *.sh 2>/dev/null | grep -q CRLF; then
            echo "âœ— Error: CRLF line endings detected in shell scripts"
            exit 1
          fi
          
          # Check for trailing whitespace
          if grep -n '[[:blank:]]$' *.sh 2>/dev/null; then
            echo "âœ— Trailing whitespace found in shell scripts"
            exit 1
          fi
          
          # Check for executable bit
          if [ ! -x sony-bravia-scripts.sh ]; then
            echo "âš  Warning: sony-bravia-scripts.sh should be executable"
          fi
          
          echo "âœ“ Shell script formatting looks good"

      - name: Check batch file line endings
        run: |
          echo "=== Checking Windows batch file line endings ==="
          
          # Windows scripts should have CRLF
          if ! file *.cmd 2>/dev/null | grep -q CRLF; then
            echo "âš  Warning: Windows batch files should have CRLF line endings"
          else
            echo "âœ“ Batch file line endings look good"
          fi

  # ============================================================================
  # LINT CHECKS (run in parallel)
  # ============================================================================

  lint-powershell:
    name: Lint PowerShell
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Write-Host "=== Running PSScriptAnalyzer ===" -ForegroundColor Cyan
          
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings ./dev/PSScriptAnalyzerSettings.psd1 -ReportSummary
          
          if ($results) {
            $results | Format-Table -AutoSize
            $errorCount = ($results | Where-Object { $_.Severity -eq 'Error' }).Count
            $warningCount = ($results | Where-Object { $_.Severity -eq 'Warning' }).Count
            
            Write-Host "`n=== Summary ===" -ForegroundColor Cyan
            Write-Host "Errors: $errorCount" -ForegroundColor $(if ($errorCount -gt 0) { 'Red' } else { 'Green' })
            Write-Host "Warnings: $warningCount" -ForegroundColor $(if ($warningCount -gt 0) { 'Yellow' } else { 'Green' })
            
            if ($errorCount -gt 0) {
              Write-Error "PSScriptAnalyzer found $errorCount error(s)"
              exit 1
            } elseif ($warningCount -gt 0) {
              Write-Warning "PSScriptAnalyzer found $warningCount warning(s)"
            }
          } else {
            Write-Host "âœ“ No issues found by PSScriptAnalyzer" -ForegroundColor Green
          }

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: psscriptanalyzer-results
          path: |
            **/*.ps1
            dev/PSScriptAnalyzerSettings.psd1

  lint-shell:
    name: Lint Shell
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          echo "=== Running ShellCheck ===" 
          
          EXIT_CODE=0
          shellcheck -x sony-bravia-scripts.sh || EXIT_CODE=$?
          
          if [ "${EXIT_CODE}" -eq 0 ]; then
            echo "âœ“ No issues found by ShellCheck"
          else
            echo "âœ— ShellCheck found issues"
            exit 1
          fi

  # ============================================================================
  # TEST SCRIPTS (run in parallel)
  # ============================================================================

  test-powershell:
    name: Test PowerShell
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run Pester tests
        shell: pwsh
        run: |
          Write-Host "=== Running Pester Tests on ${{ matrix.os }} ===" -ForegroundColor Cyan
          
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $true
          $config.Output.Verbosity = 'Detailed'
          $config.CodeCoverage.Enabled = $false
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.TestResult.OutputPath = 'testResults.xml'
          
          Invoke-Pester -Configuration $config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: powershell-test-results-${{ matrix.os }}
          path: testResults.xml

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && matrix.os == 'ubuntu-latest'
        with:
          files: testResults.xml
          check_name: PowerShell Test Results

  test-shell:
    name: Test Shell
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y bats
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install bats-core
          fi

      - name: Make scripts executable
        run: chmod +x sony-bravia-scripts.sh

      - name: Run bats tests
        run: |
          echo "=== Running Bats Tests on ${{ matrix.os }} ==="
          bats tests/launcher.bats
          
          # Windows launcher tests (may not fully work on Unix but check syntax)
          bats tests/launcher-windows.bats || echo "âš  Windows launcher tests skipped on Unix"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shell-test-results-${{ matrix.os }}
          path: tests/*.bats

  # ============================================================================
  # PACKAGE (only runs after all checks pass)
  # ============================================================================

  package:
    name: Package Release
    runs-on: ubuntu-latest
    needs: [format-powershell, format-shell, lint-powershell, lint-shell, test-powershell, test-shell]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create PowerShell package
        run: |
          echo "=== Creating PowerShell package ==="
          
          mkdir -p dist
          
          # Create zip with PowerShell script and Windows launcher
          zip -r dist/sony-bravia-scripts-powershell.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.cmd \
            readme.md \
            license.md
          
          echo "âœ“ PowerShell package created"

      - name: Create Shell package
        run: |
          echo "=== Creating Shell package ==="
          
          # Create zip with PowerShell script and Unix launcher
          zip -r dist/sony-bravia-scripts-unix.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.sh \
            readme.md \
            license.md
          
          echo "âœ“ Shell package created"

      - name: Create complete package
        run: |
          echo "=== Creating complete package ==="
          
          # Create zip with all files
          zip -r dist/sony-bravia-scripts-complete.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.cmd \
            sony-bravia-scripts.sh \
            readme.md \
            license.md \
            PSScriptAnalyzerSettings.psd1 \
            .shellcheckrc \
            .editorconfig \
            tests/
          
          echo "âœ“ Complete package created"

      - name: Display package info
        run: |
          echo "=== Package Information ==="
          ls -lh dist/
          echo ""
          echo "Packages created:"
          echo "  - sony-bravia-scripts-powershell.zip (PowerShell + Windows launcher)"
          echo "  - sony-bravia-scripts-unix.zip (PowerShell + Unix launcher)"
          echo "  - sony-bravia-scripts-complete.zip (All files including tests)"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: dist/*.zip
          retention-days: 30

      - name: Generate release summary
        run: |
          echo "## ðŸ“¦ Release Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed! Packages created successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Downloads:" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-powershell.zip\` - For Windows users" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-unix.zip\` - For macOS/Linux users" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-complete.zip\` - Complete source with tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Sizes:" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ | tail -n +2 | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY


