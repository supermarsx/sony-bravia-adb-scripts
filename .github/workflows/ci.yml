name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  # ============================================================================
  # FORMAT CHECKS (run in parallel)
  # ============================================================================

  format-powershell:
    name: Format PowerShell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PowerShell file formatting
        shell: pwsh
        run: |
          Write-Host "=== Checking PowerShell formatting ===" -ForegroundColor Cyan

          $issues = @()

          # Check for trailing whitespace
          $psFiles = Get-ChildItem -Path . -Filter "*.ps1" -Recurse
          foreach ($file in $psFiles) {
            $lines = Get-Content $file.FullName
            for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i] -match '\s+$') {
                $issues += "Trailing whitespace in $($file.Name):$($i+1)"
              }
            }
          }

          # Check for tabs (should use spaces)
          foreach ($file in $psFiles) {
            $content = Get-Content $file.FullName -Raw
            if ($content -match "`t") {
              $issues += "Tab character found in $($file.Name) (use spaces)"
            }
          }

          if ($issues.Count -gt 0) {
            $issues | ForEach-Object { Write-Host "âœ— $_" -ForegroundColor Red }
            exit 1
          }

          Write-Host "âœ“ PowerShell formatting looks good" -ForegroundColor Green

      - name: Check EditorConfig compliance
        uses: editorconfig-checker/action-editorconfig-checker@main
        with:
          version: "2.7.0"

  format-shell:
    name: Format Shell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check shell script formatting
        run: |
          echo "=== Checking shell script formatting ==="

          # Check for CRLF line endings (should be LF only)
          if file *.sh 2>/dev/null | grep -q CRLF; then
            echo "âœ— Error: CRLF line endings detected in shell scripts"
            exit 1
          fi

          # Check for trailing whitespace
          if grep -n '[[:blank:]]$' *.sh 2>/dev/null; then
            echo "âœ— Trailing whitespace found in shell scripts"
            exit 1
          fi

          # Check for executable bit
          if [ ! -x sony-bravia-scripts.sh ]; then
            echo "âš  Warning: sony-bravia-scripts.sh should be executable"
          fi

          echo "âœ“ Shell script formatting looks good"

      - name: Check batch file line endings
        run: |
          echo "=== Checking Windows batch file line endings ==="

          # Windows scripts should have CRLF
          if ! file *.cmd 2>/dev/null | grep -q CRLF; then
            echo "âš  Warning: Windows batch files should have CRLF line endings"
          else
            echo "âœ“ Batch file line endings look good"
          fi

  # ============================================================================
  # LINT CHECKS (run in parallel)
  # ============================================================================

  lint-powershell:
    name: Lint PowerShell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          ./dev/lint-powershell.ps1

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: psscriptanalyzer-results
          path: |
            **/*.ps1
            dev/PSScriptAnalyzerSettings.psd1

  lint-shell:
    name: Lint Shell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          echo "=== Running ShellCheck ==="

          EXIT_CODE=0
          shellcheck -x sony-bravia-scripts.sh || EXIT_CODE=$?

          if [ "${EXIT_CODE}" -eq 0 ]; then
            echo "âœ“ No issues found by ShellCheck"
          else
            echo "âœ— ShellCheck found issues"
            exit 1
          fi

  # ============================================================================
  # TEST SCRIPTS (run in parallel)
  # ============================================================================

  test-powershell:
    name: Test PowerShell
    runs-on: ${{ matrix.os }}
    needs: [format-powershell, format-shell, lint-powershell, lint-shell]
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run Pester tests
        shell: pwsh
        run: |
          Write-Host "=== Running Pester Tests on ${{ matrix.os }} ===" -ForegroundColor Cyan

          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $true
          $config.Output.Verbosity = 'Detailed'
          $config.CodeCoverage.Enabled = $false
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.TestResult.OutputPath = 'testResults.xml'

          Invoke-Pester -Configuration $config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: powershell-test-results-${{ matrix.os }}
          path: testResults.xml

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && matrix.os == 'ubuntu-latest'
        with:
          files: testResults.xml
          check_name: PowerShell Test Results

  test-shell:
    name: Test Shell
    runs-on: ${{ matrix.os }}
    needs: [format-powershell, format-shell, lint-powershell, lint-shell]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y bats
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install bats-core
          fi

      - name: Make scripts executable
        run: chmod +x sony-bravia-scripts.sh

      - name: Run bats tests
        run: |
          echo "=== Running Bats Tests on ${{ matrix.os }} ==="
          bats tests/launcher.bats

          # Windows launcher tests (may not fully work on Unix but check syntax)
          bats tests/launcher-windows.bats || echo "âš  Windows launcher tests skipped on Unix"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shell-test-results-${{ matrix.os }}
          path: tests/*.bats

  # ============================================================================
  # PACKAGE (only runs after all checks pass)
  # ============================================================================

  package:
    name: Package Release
    runs-on: ubuntu-latest
    needs:
      [
        format-powershell,
        format-shell,
        lint-powershell,
        lint-shell,
        test-powershell,
        test-shell,
      ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create PowerShell package
        run: |
          echo "=== Creating PowerShell package ==="

          mkdir -p dist

          # Create zip with PowerShell script and Windows launcher
          zip -r dist/sony-bravia-scripts-powershell.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.cmd \
            readme.md \
            license.md

          echo "âœ“ PowerShell package created"

      - name: Create Shell package
        run: |
          echo "=== Creating Shell package ==="

          # Create zip with PowerShell script and Unix launcher
          zip -r dist/sony-bravia-scripts-unix.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.sh \
            readme.md \
            license.md

          echo "âœ“ Shell package created"

      - name: Create complete package
        run: |
          echo "=== Creating complete package ==="

          # Create zip with all files
          zip -r dist/sony-bravia-scripts-complete.zip \
            sony-bravia-scripts.ps1 \
            sony-bravia-scripts.cmd \
            sony-bravia-scripts.sh \
            readme.md \
            license.md \
            PSScriptAnalyzerSettings.psd1 \
            .shellcheckrc \
            .editorconfig \
            tests/

          echo "âœ“ Complete package created"

      - name: Display package info
        run: |
          echo "=== Package Information ==="
          ls -lh dist/
          echo ""
          echo "Packages created:"
          echo "  - sony-bravia-scripts-powershell.zip (PowerShell + Windows launcher)"
          echo "  - sony-bravia-scripts-unix.zip (PowerShell + Unix launcher)"
          echo "  - sony-bravia-scripts-complete.zip (All files including tests)"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: dist/*.zip
          retention-days: 30

      - name: Generate release summary
        run: |
          echo "## ðŸ“¦ Release Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed! Packages created successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Downloads:" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-powershell.zip\` - For Windows users" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-unix.zip\` - For macOS/Linux users" >> $GITHUB_STEP_SUMMARY
          echo "- \`sony-bravia-scripts-complete.zip\` - Complete source with tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Sizes:" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ | tail -n +2 | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ROLLING RELEASE (only on main branch push)
  # ============================================================================

  rolling-release:
    name: Rolling Release
    runs-on: ubuntu-latest
    needs: [package]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist

      - name: Generate release info
        id: release_info
        run: |
          # Get short commit hash
          SHORT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_DATE=$(git log -1 --pretty=format:"%ci")

          echo "short_hash=${SHORT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "commit_author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT

          # Create release notes
          cat > RELEASE_NOTES.md << EOF
          # Rolling Release - ${SHORT_HASH}

          **Automated build from latest commit**

          ## Commit Information

          - **Hash:** \`${SHORT_HASH}\` (\`${GITHUB_SHA}\`)
          - **Message:** ${COMMIT_MSG}
          - **Author:** ${COMMIT_AUTHOR}
          - **Date:** ${COMMIT_DATE}
          - **Branch:** ${GITHUB_REF_NAME}

          ## ðŸ“¦ Packages

          This rolling release includes the latest development build with all CI checks passed.

          ### Available Downloads:

          - **sony-bravia-scripts-powershell.zip** - Windows package with .cmd launcher
          - **sony-bravia-scripts-unix.zip** - macOS/Linux package with .sh launcher
          - **sony-bravia-scripts-complete.zip** - Complete package with tests and dev tools

          ### Installation:

          **Windows:**
          \`\`\`powershell
          # Extract sony-bravia-scripts-powershell.zip
          .\install.ps1
          \`\`\`

          **macOS/Linux:**
          \`\`\`bash
          # Extract sony-bravia-scripts-unix.zip
          chmod +x install.sh
          ./install.sh
          \`\`\`

          ## âš ï¸ Rolling Release Notice

          This is an automated rolling release that reflects the latest state of the ${GITHUB_REF_NAME} branch.

          - âœ… All CI checks have passed
          - ðŸ”„ Updated automatically on every push
          - ðŸ§ª May contain experimental features
          - ðŸ“Œ For stable releases, use tagged versions

          ## Changes Since Last Build

          See commit history: [${SHORT_HASH}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})

          ---

          **Build:** [#${GITHUB_RUN_NUMBER}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})
          **Built:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

          cat RELEASE_NOTES.md

      - name: Delete existing rolling release
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete the rolling tag and release if they exist
          gh release delete rolling --yes || true
          git push origin :refs/tags/rolling || true

      - name: Create rolling tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f rolling
          git push -f origin rolling

      - name: Create rolling release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create rolling \
            --title "Rolling Release (${{ steps.release_info.outputs.short_hash }})" \
            --notes-file RELEASE_NOTES.md \
            --prerelease \
            dist/sony-bravia-scripts-powershell.zip \
            dist/sony-bravia-scripts-unix.zip \
            dist/sony-bravia-scripts-complete.zip

      - name: Update release summary
        run: |
          echo "## ðŸš€ Rolling Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [rolling (${{ steps.release_info.outputs.short_hash }})](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/rolling)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Available:" >> $GITHUB_STEP_SUMMARY
          echo "- sony-bravia-scripts-powershell.zip" >> $GITHUB_STEP_SUMMARY
          echo "- sony-bravia-scripts-unix.zip" >> $GITHUB_STEP_SUMMARY
          echo "- sony-bravia-scripts-complete.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commit:" >> $GITHUB_STEP_SUMMARY
          echo "- **Hash:** \`${{ steps.release_info.outputs.short_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${{ steps.release_info.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ steps.release_info.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # UPDATE PACKAGE MANAGER RECIPES (after rolling release)
  # ============================================================================

  update-package-managers:
    name: Update Package Managers
    runs-on: ubuntu-latest
    needs: [rolling-release]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate SHA256 hashes
        id: hashes
        run: |
          # Download release assets to calculate hashes
          REPO="${GITHUB_REPOSITORY}"

          # Download packages
          curl -L "https://github.com/${REPO}/releases/download/rolling/sony-bravia-scripts-powershell.zip" -o powershell.zip
          curl -L "https://github.com/${REPO}/releases/download/rolling/sony-bravia-scripts-unix.zip" -o unix.zip

          # Calculate SHA256
          POWERSHELL_SHA256=$(sha256sum powershell.zip | awk '{print $1}')
          UNIX_SHA256=$(sha256sum unix.zip | awk '{print $1}')

          echo "powershell_sha256=${POWERSHELL_SHA256}" >> $GITHUB_OUTPUT
          echo "unix_sha256=${UNIX_SHA256}" >> $GITHUB_OUTPUT

          echo "PowerShell package SHA256: ${POWERSHELL_SHA256}"
          echo "Unix package SHA256: ${UNIX_SHA256}"

          # Cleanup
          rm powershell.zip unix.zip

      - name: Get commit info
        id: commit_info
        run: |
          SHORT_HASH=$(git rev-parse --short HEAD)
          FULL_HASH=$(git rev-parse HEAD)

          echo "short_hash=${SHORT_HASH}" >> $GITHUB_OUTPUT
          echo "full_hash=${FULL_HASH}" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          echo "Updating Homebrew formula..."

          # Update SHA256 in formula
          sed -i "s/sha256 \".*\"/sha256 \"${{ steps.hashes.outputs.unix_sha256 }}\"/" homebrew/sony-bravia-scripts.rb

          # Update version with commit hash
          sed -i "s/version \".*\"/version \"2.0.0-${{ steps.commit_info.outputs.short_hash }}\"/" homebrew/sony-bravia-scripts.rb

          echo "âœ“ Homebrew formula updated"
          cat homebrew/sony-bravia-scripts.rb

      - name: Update Scoop manifest
        run: |
          echo "Updating Scoop manifest..."

          # Update hash and version in JSON
          jq --arg hash "${{ steps.hashes.outputs.powershell_sha256 }}" \
             --arg version "2.0.0-${{ steps.commit_info.outputs.short_hash }}" \
             '.hash = $hash | .version = $version' \
             scoop/sony-bravia-scripts.json > scoop/sony-bravia-scripts.json.tmp

          mv scoop/sony-bravia-scripts.json.tmp scoop/sony-bravia-scripts.json

          echo "âœ“ Scoop manifest updated"
          cat scoop/sony-bravia-scripts.json

      - name: Update WinGet manifest
        run: |
          echo "Updating WinGet manifest..."

          # Update SHA256 in YAML
          sed -i "s/InstallerSha256: .*/InstallerSha256: ${{ steps.hashes.outputs.powershell_sha256 }}/" winget/sony-bravia-scripts.yaml

          # Update version (use commit count for build number)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          sed -i "s/PackageVersion: .*/PackageVersion: 2.0.0.${COMMIT_COUNT}/" winget/sony-bravia-scripts.yaml

          echo "âœ“ WinGet manifest updated"
          cat winget/sony-bravia-scripts.yaml

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit changes
          git add homebrew/ scoop/ winget/
          git commit -m "chore: update package manager recipes for rolling release ${{ steps.commit_info.outputs.short_hash }}"

          # Push changes
          git push origin HEAD:${GITHUB_REF#refs/heads/}

          echo "âœ“ Package manager recipes updated and pushed"

      - name: Update summary
        run: |
          echo "## ðŸ“¦ Package Manager Recipes Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Updated recipes with SHA256 hashes from rolling release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Homebrew Formula" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`homebrew/sony-bravia-scripts.rb\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`2.0.0-${{ steps.commit_info.outputs.short_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: \`${{ steps.hashes.outputs.unix_sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scoop Manifest" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`scoop/sony-bravia-scripts.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`2.0.0-${{ steps.commit_info.outputs.short_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: \`${{ steps.hashes.outputs.powershell_sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### WinGet Manifest" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`winget/sony-bravia-scripts.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: \`${{ steps.hashes.outputs.powershell_sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Homebrew (macOS/Linux)" >> $GITHUB_STEP_SUMMARY
          echo "brew install homebrew/sony-bravia-scripts.rb" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Scoop (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "scoop install scoop\\sony-bravia-scripts.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# WinGet (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "winget install --manifest winget\\" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
